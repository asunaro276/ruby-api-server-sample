# コメント機能 仕様

## ADDED Requirements

### Requirement: コメント作成
システムは認証済みユーザーが投稿にコメントを追加する機能を提供するものとします（SHALL provide comment creation）。

#### Scenario: 投稿にコメントを追加
- **WHEN** 認証済みユーザーが `POST /api/v1/posts/:post_id/comments` に有効なコメント内容（content）を送信
- **THEN** 投稿にコメントが追加される
- **AND** コメント情報（コメント内容、作成者情報、作成日時）が返される
- **AND** 投稿のコメント数が1増加する
- **AND** ステータスコード 201 (Created) が返される

#### Scenario: 空のコメント内容で作成
- **WHEN** 認証済みユーザーが空のコメント内容を送信
- **THEN** バリデーションエラーが返される
- **AND** エラーメッセージに「コメント内容を入力してください」と表示される
- **AND** ステータスコード 422 (Unprocessable Entity) が返される

#### Scenario: 280文字を超えるコメント内容で作成
- **WHEN** 認証済みユーザーが280文字を超えるコメント内容を送信
- **THEN** バリデーションエラーが返される
- **AND** エラーメッセージに「コメント内容は280文字以内である必要があります」と表示される
- **AND** ステータスコード 422 (Unprocessable Entity) が返される

#### Scenario: 存在しない投稿にコメント
- **WHEN** 認証済みユーザーが存在しない投稿にコメントを試みる
- **THEN** エラーメッセージが返される
- **AND** ステータスコード 404 (Not Found) が返される

#### Scenario: 認証なしでコメントを作成
- **WHEN** 未認証のユーザーがコメント作成を試みる
- **THEN** 認証エラーメッセージが返される
- **AND** ステータスコード 401 (Unauthorized) が返される

### Requirement: コメント一覧取得
システムは投稿のコメント一覧を取得する機能を提供するものとします（SHALL provide comments listing）。

#### Scenario: 投稿のコメント一覧を取得
- **WHEN** クライアントが `GET /api/v1/posts/:post_id/comments` にリクエストを送信
- **THEN** 投稿のコメント一覧が古い順（作成日時の昇順）に返される
- **AND** 各コメントには作成者情報（username, avatar_url）と作成日時が含まれる
- **AND** ステータスコード 200 (OK) が返される

#### Scenario: コメントがゼロの投稿のコメント一覧を取得
- **WHEN** クライアントがコメントがない投稿のコメント一覧を取得
- **THEN** 空の配列が返される
- **AND** ステータスコード 200 (OK) が返される

#### Scenario: ページネーション付きでコメント一覧を取得
- **WHEN** クライアントがページ番号とページサイズをクエリパラメータで指定
- **THEN** 指定されたページのコメント一覧が返される
- **AND** ページネーション情報（総ページ数、現在のページなど）が含まれる
- **AND** ステータスコード 200 (OK) が返される

### Requirement: コメント削除
システムは認証済みユーザーが自分のコメントを削除する機能を提供するものとします（SHALL provide comment deletion）。

#### Scenario: 自分のコメントを削除
- **WHEN** 認証済みユーザーが `DELETE /api/v1/comments/:id` にリクエストを送信
- **THEN** コメントが削除される
- **AND** 削除成功メッセージが返される
- **AND** 投稿のコメント数が1減少する
- **AND** ステータスコード 200 (OK) が返される

#### Scenario: 他人のコメントを削除
- **WHEN** 認証済みユーザーが他のユーザーのコメントを削除しようとする
- **THEN** 権限エラーメッセージが返される
- **AND** ステータスコード 403 (Forbidden) が返される

#### Scenario: 認証なしでコメントを削除
- **WHEN** 未認証のユーザーがコメント削除を試みる
- **THEN** 認証エラーメッセージが返される
- **AND** ステータスコード 401 (Unauthorized) が返される

#### Scenario: 存在しないコメントを削除
- **WHEN** 認証済みユーザーが存在しないコメントを削除しようとする
- **THEN** エラーメッセージが返される
- **AND** ステータスコード 404 (Not Found) が返される

### Requirement: コメント数のカウント
システムは投稿のコメント数を正確にカウントする機能を提供するものとします（MUST accurately count comments）。

#### Scenario: コメント追加時にカウント更新
- **WHEN** ユーザーが投稿にコメントを追加
- **THEN** 投稿の `comments_count` が1増加する
- **AND** カウンターキャッシュが更新される

#### Scenario: コメント削除時にカウント更新
- **WHEN** ユーザーがコメントを削除
- **THEN** 投稿の `comments_count` が1減少する
- **AND** カウンターキャッシュが更新される

### Requirement: コメントの投稿者確認
システムはコメントの投稿者を適切に表示する機能を提供するものとします（SHALL display comment authors）。

#### Scenario: コメント一覧での投稿者情報表示
- **WHEN** クライアントがコメント一覧を取得
- **THEN** 各コメントに投稿者のユーザー名とアバターURLが含まれる
- **AND** 投稿者が削除されている場合は「削除されたユーザー」と表示される
